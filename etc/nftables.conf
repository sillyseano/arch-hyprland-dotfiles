#!/usr/bin/nft -f
flush ruleset

table inet filter {
    chain input {
        type filter hook input priority filter; policy drop;
        # Allow all traffic on loopback
        iif "lo" accept

        # Allow established/related connections
        ct state established,related accept

        # ICMP for ping/network diagnostics
        ip protocol icmp accept
        ip6 nexthdr icmpv6 accept

        # World of Warcraft ports
        tcp dport { 1119, 3724, 6112-6114, 8085 } accept
        udp dport 3724 accept

        # DHCP: replies from libvirt DHCP server to host
        udp sport 67 udp dport 68 accept

        # mDNS/SSDP for local discovery
        udp dport 5353 accept
        udp sport 5353 accept

        # DNS queries from VMs on virbr0
        iif "virbr0" udp dport 53 accept
        iif "virbr0" tcp dport 53 accept
    }

    ### Output chain
    chain output {
        type filter hook output priority filter; policy accept;
    }

    ### Forward chain
    chain forward {
        type filter hook forward priority filter; policy drop;

        # Established/related traffic
        ct state established,related accept

        # Forwarding between VM network (virbr0) and physical NIC
        iifname "virbr0" oifname "enp12s0" accept
        iifname "enp12s0" oifname "virbr0" accept

        # DNS forwarding from VM subnet
        iifname "virbr0" oifname "enp12s0" udp dport 53 accept
        iifname "virbr0" oifname "enp12s0" tcp dport 53 accept

        # DHCP forwarding between VM and host
        iifname "virbr0" oifname "enp12s0" udp sport 68 udp dport 67 accept
        iifname "enp12s0" oifname "virbr0" udp sport 67 udp dport 68 accept
    }
}

table ip nat {
    chain postrouting {
        type nat hook postrouting priority 100; policy accept;

        # Masquerade VM subnet traffic leaving physical NIC
        oifname "enp12s0" ip saddr 192.168.122.0/24 masquerade
    }
}


